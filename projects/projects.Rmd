---
title: "Graphical Analyses of Seattle's Bicycle Sharing System"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: bookdown::html_document2
---



```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE, fig.align = "center", comment = NA, warning = FALSE, message = FALSE, prompt = TRUE)

```



We find the orignal information for this project [here](https://proquestionasker.github.io/projects/2016/11/10/bicyclesseattle/).



```{r, echo = FALSE, warning = FALSE, message=FALSE}

#loading the  data

# For data manipulation and tidying
library(dplyr)
library(lubridate)
library(tidyr)

# For mapping
library(ggmap)
library(mapproj)

# For data visualizations
library(ggplot2)

# For modeling and machine learning
library(caret)
library(lubridate)

station <- read.csv(file = "station.csv", header = TRUE, 
                    stringsAsFactors = FALSE)

trip <- read.csv(file = "trip.csv", header = TRUE, 
                 stringsAsFactors = FALSE)

weather <- read.csv(file = "weather.csv", header = TRUE, 
                    stringsAsFactors = FALSE)
```

# **Introduction** 
This is a report and analysis on Seattle's bicycle sharing trends. The data includes weather reports for the area (excluding summer logistics), the station locations, as well as trips taken by cycle riders. Future explorations of this type of data could include investigating more extensively overall public transportation data trends for this area. This would serve to establish a better understanding of public transportation trends. *Interestingly enough*, this transportation company has since dissolved and the data points that were collected from this company are therefore older. Thus, these trends are potentially not reflective of bicycle sharing as it stands in Seattle to date.


```{r, echo=FALSE}

knitr:: include_graphics("bikes.jpg")

```

# Station Locations

Look how widespread the rental stations are all over Seattle (see Figure \@ref(fig:BSL))!

```{r, label = "BSL", fig.cap = "Seattle Bike Station Locations", echo = FALSE, warnings = FALSE, message=FALSE}

#For show (the graphs; evidence) Formating the dates
station$install_date <- mdy(station$install_date)


# How many times were new stations installed?
station %>% summarise(n_distinct(install_date))
# How many stations were installed on each date
station %>% group_by(install_date) %>% summarise(count = n()) %>% 
  arrange(install_date)



station %>% summarise(n_distinct(station_id))

station_locs <- station %>% group_by(station_id) %>% select(1:4, -2)

mymap <- get_map(location = c(lat = 47.60, lon = -122.35), maptype = "roadmap", zoom = 12)

# Plot a single point for each Station ID
ggmap(mymap) + geom_point(aes(x = long, y = lat), data = station_locs, 
                          alpha = 1, color = "darkred", size = 2)

```

## Locations (zoomed)

For optimal viewing, here are the station whereabouts with some zoom for location precision.

```{r, label = "closeUp",  fig.cap = "Closeup", warning=FALSE, message=FALSE, echo = FALSE}

closeUp <- get_map(location = "Seattle", maptype = "roadmap", zoom = 13)

# Plot a single point for each Station ID
ggmap(closeUp) + geom_point(aes(x = long, y = lat), data = station_locs, 
                            alpha = 1, color = "darkred", size = 3)

```


Look at all those stations! Its hard to believe this company managed to go out of business!


## Current Dock Count

```{r, label = "nbs",  fig.cap = "Bike Count", echo = FALSE, message=FALSE, warning = FALSE}

#histogram showing current dock count
ggplot(data = station, aes (x = current_dockcount)) +
  geom_bar(fill = "lightcoral", color = "gold") +
  theme_classic() +
  labs( x = "Number of bikes per station", y= "Count", title = "Current Dock Count")

```

Quite a few bikes to choose from!




## Change in Number of Bike Docks Per Station

```{r, label = "bikesPerStation", fig.cap= "Bikes Per Station", warning = FALSE, message=FALSE, echo = FALSE}

dock_change <- station %>% group_by(station_id) %>% select(station_id, 
                                                           long, lat, ends_with("dockcount")) %>% mutate(dock_change = current_dockcount - 
                                                                                                           install_dockcount)


closeUp <- get_map(location = "Seattle", maptype = "roadmap", zoom = 13)

ggmap(closeUp) + geom_point(aes(x = long, y = lat, size = factor(dock_change), 
                                color = factor(dock_change)), 
                            data = dock_change, alpha = 0.8) + 
  guides(color = guide_legend(title = "change"), size = guide_legend(title = "change")) + 
  scale_size_manual(values = 10:1)




# Change in docking station 
dock_change <- station %>% group_by(station_id) %>% select(station_id, 
                                                           long, lat, ends_with("dockcount")) %>% mutate(dock_change = current_dockcount -     install_dockcount)


```


11 stations lost bike docks, 39 docks stayed the same, 8 stations gained docks.


# Number of Rides Per Day

```{r, label = "visualRidesPerDay", fig.cap = "Daily Riders", message=FALSE, echo = FALSE}

# Make the start and stop dates into POSIXct objects
trip_2 <- trip %>% mutate(start_dt = mdy_hm(starttime), stop_dt = mdy_hm(stoptime))

trip_2 <- trip_2 %>% mutate(start_date = paste(month(start_dt), 
                                               day(start_dt), year(start_dt), sep = "/"))
trip_2$start_date <- mdy(trip_2$start_date)

trip_2 <- trip_2 %>% mutate(stop_date = paste(month(stop_dt), 
                                              day(stop_dt), year(stop_dt), sep = "/"))
trip_2$stop_date <- mdy(trip_2$stop_date)


# Recode the dates
trip_2 %>% 
  
  group_by(start_date) %>%
  
  summarize(N = n()) %>%
  
  ggplot(aes(x = start_date, y = N)) + 
  
  geom_line() + 
  
  labs(x = "Date", y = "Number of trips per day") + 
  
  theme_bw() + geom_smooth()


```

People really like going on fall and spring rides multiple times a day. Can you blame them though, Seattle in the fall is remarkable!!


```{r, echo=FALSE}

knitr:: include_graphics("fall.jpg")

```


# Plotting trips per month (by season; excluding summer)

```{r, label = "monthSeason", fig.cap = "Trips by season, per month", message=FALSE, echo = FALSE}

start_date_ym <- trip_2 %>% 
  mutate(ym = paste(year(start_date), 
                    month(start_date), sep = "/"), Season = ifelse(ym %in% c("2014/10", "2014/11"), "Fall",
                                                                   ifelse(ym %in% c("2014/12", "2015/1", "2015/2"), "Winter",
                                                                          ifelse(ym %in% c("2015/3", "2015/4", "2015/5"), "Spring", "Summer"))))


# ggplot(start_date_ym, aes(x = start_date, y = N))
names(start_date_ym)


start_date_ym %>%
  group_by(ym, Season) %>%
  summarize(N=n()) %>%
  ggplot(aes(x = ym, y = N, color = Season, fill = Season, group = Season)) + 
  geom_point() +
  geom_line(group = 1) + 
  theme_bw() +
  labs( x = "Date", y = "Number of Trips(per month)")

```



# Converting Trip Duration from Seconds to Minutes 

```{r, label = "minutesSeason", fig.cap= "Conversions", message=FALSE, echo = FALSE}

Trip_Duration_Month <- start_date_ym %>% 
  mutate(trip_duration_min = tripduration/60) %>% 
  group_by(ym) %>% 
  select(ym, trip_duration_min, Season) %>% 
  summarise(Avg = mean(trip_duration_min), 
            sd = sd(trip_duration_min)) %>% 
  mutate(se = sd/sqrt(n()), Season = ifelse(ym %in% c("2014/10", "2014/11"), "Fall",
                                                                   ifelse(ym %in% c("2014/12", "2015/1", "2015/2"), "Winter",
                                                                          ifelse(ym %in% c("2015/3", "2015/4", "2015/5"), "Spring", "Summer"))))

Trip_Duration_Month %>%
  ggplot(aes(x = ym, y = Avg, col = Season, fill = Season, group = Season)) + 
  geom_point()+
  geom_line(aes(group = 1)) + 
  labs(x = "Date" , y = "Duration of Average Trip (minutes)") + 
  theme_bw() + 
  geom_errorbar(aes(ymin = Avg - se, ymax = Avg + se))
  
```

# Number of Trips by Day of Week

```{r, fig.cap = "Weekday Trips", echo = FALSE, warning=FALSE, message=FALSE}

 trip_2$wd <- wday(trip_2$start_date, label = TRUE)
 tripduration_m <- (trip_2$tripduration)/60
 trip22<-trip_2
 trip22<-cbind(trip22, tripduration_m)
 ym <- format(trip22$start_date, "%Y/%m")
 trip22<- cbind(trip22,ym)
 
 trip22 <-mutate(trip22, Season = ifelse(ym %in% c("2014/10", "2014/11"), "Fall",
                                      ifelse(ym %in% c("2014/12", "2015/1", "2015/2"), "Winter",
                                      ifelse(ym %in% c("2015/3", "2015/4", "2015/5"), "Spring", "Summer"))))%>%
   group_by(Season)
 

trip22 %>%
  group_by(wd, Season) %>%
  summarize(N = n())%>%
  ggplot(aes(x = wd, y = N, col = Season, fill = Season, group = Season)) + 
  geom_point() + 
  geom_line() + 
  theme_bw() + 
  labs(x = "Day of the Week", y= "Number of Trips", title = "Trips Per Day")


```

# Number of Trips Per Time of Day

```{r, fig.cap = "Daily Trip Log", message = FALSE, warnings = FALSE, echo = FALSE}

trip22 %>%
  group_by(Hour = hour(start_dt), Season, wd) %>%
  summarize(N = n()) %>%
 ggplot(aes(x = Hour, y= N, color = Season, group = Season)) +
  geom_point() +
  geom_line() + 
  facet_wrap(~wd) + 
  theme_bw() +
  labs(x = "Hour of Day", y = "Number of Trips")

```

# Number of Trips by Member Type

```{r, fig.cap = "Trips of Members v. Short-Term Pass Holder", message = FALSE, warnings = FALSE, echo = FALSE}

trip22 %>%
  filter(usertype !="") %>%
  group_by(Season, usertype, ym) %>%
  summarize(N = n()) %>%
  ggplot(aes(x = ym, y = N, color = Season, group = usertype, fill = usertype)) + 
  geom_point(aes(shape = usertype), size = 3) + 
  geom_line() + 
  theme_bw() + 
  labs(x = "Date", y= "Total Number of Trips Per Month")

```

# Trip Duration by Member Type

```{r, fig.cap = "Members v. Short-Term Pass Holder", message = FALSE, warnings = FALSE, echo = FALSE}

#Frequency histogram
library(tidyverse)
start_date_ym <- mutate(start_date_ym, freelim= ifelse(usertype=="Member", 45, 30))
start_date_ym %>%
  filter(usertype !="") %>%
  group_by(tripduration, trip_id, usertype, freelim) %>%
  summarize(N=n()) %>%
  ggplot(aes(x=tripduration/60, fill=usertype), group=usertype) +
    geom_histogram(binwidth = 2, show.legend = FALSE) +
    xlim(1,60) +
    facet_grid(.~usertype) + 
    scale_fill_manual(values=c("seagreen1", "navy")) +
    theme_bw() +
    guides(colour=FALSE) +
    geom_vline(aes(xintercept=freelim), linetype="dashed") +
    labs(x="Trip Duration (minutes)", y="Number of Trips") 

```



##Cost of a Biking Trip 

```{r, label = "CBT", fig.cap = "Trip Cost for Members v. Non-Members", echo = FALSE, message = FALSE, warnings = FALSE}

start_date_ym <- mutate(start_date_ym, tripduration_m = tripduration/60)
start_date_ym <- start_date_ym %>% mutate(cost = ifelse(usertype == "Member" & tripduration_m <= 45,0, ifelse(usertype == "Member" & tripduration_m > 45 & tripduration_m <= 75, 2, ifelse(usertype == "Member" & tripduration_m > 75, (2 + 2*ceiling((tripduration_m -75)/30)), ifelse(usertype == "Short-Term Pass Holder" & tripduration_m <= 30, 0, ifelse(usertype == "Short-Term Pass Holder" & tripduration_m > 30 & tripduration_m < 60, 2, ifelse(usertype == "Short-Term Pass Holder" & tripduration_m > 60, (2 + 5 * ceiling((tripduration_m - 60)/30)), NA)))))))
  
  
start_date_ym %>%
  filter(cost > 0) %>%
ggplot(aes(x = cost, fill = usertype)) +
  geom_histogram() +
  facet_grid(.~ usertype) +
  scale_fill_manual(values = c("steelblue1", "gold")) +
  guides(fill = F) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
  labs(x = "Additional Fee($)")

```
It is definitely worth it to be a member vs. a nonmember, there are many associated costs if you aren't.(see Figure \@ref(fig:CBT))!




# Bicycle Sharing Member Demographics

Riders tend to be aged towards the upper 20s, but this number could be misleading because we don't have any real identifiers for the users (i.e. is one 20 year old taking 100 trips a day, or if there are a ton of 20 year olds using the service one time).

```{r, fig.cap = "Member Ages", message = FALSE, warnings = FALSE, echo = FALSE}

trip_2$usertype <- as.factor(trip_2$usertype)
trip_age <- trip_2 %>% mutate(age = year(start_dt) - birthyear)

hist(trip_age$age, main = "Member Age", xlab = "Number of Riders", col = "plum1", breaks = 25)

```



#Temperature Quartiles

## Minimum Temperatures

```{r, label = "temps min", message = FALSE, warnings = FALSE, echo = FALSE}

# Adjusting the Date Variable
weather$Date <- mdy(weather$Date)

# Adjusting the Events Variable
weather$Events <- as.factor(weather$Events)


levels(weather$Events)

weather$Events <- gsub("Fog , Rain|Fog-Rain", "Fog-Rain", weather$Events)
weather$Events <- gsub("Rain , Snow|Rain-Snow", "Rain-Snow", 
    weather$Events)
weather$Events <- gsub("Rain , Thunderstorm|Rain-Thunderstorm", 
    "Rain-TS", weather$Events)

weather$Events <- as.factor(weather$Events)

weather$Max_Gust_Speed_MPH <- gsub("-", 0, weather$Max_Gust_Speed_MPH)

weather$Max_Gust_Speed_MPH <- as.numeric(weather$Max_Gust_Speed_MPH)

weather[which(is.na(weather$Mean_Temperature_F)), 1]
weather[490, "Mean_Temperature_F"] <- 50

weather$Events <- gsub("^$", "Other", weather$Events)
weather$Events <- as.factor(weather$Events)



weather %>% 
  
  group_by(Date) %>%
  
  ggplot(aes(x = Date, y = Min_TemperatureF)) + 
  
  geom_line() + 
  
  labs(x = "Date", y = "Minimum Temperature (F)") + 
  
  theme_bw() 


```

##Mean Temperatures


```{r, label = "temp means", message = FALSE, warnings = FALSE, echo = FALSE}

weather %>% 
  
  group_by(Date) %>%
  
  ggplot(aes(x = Date, y = as.numeric(Mean_Temperature_F))) + 
  
  geom_line() + 
  
  labs(x = "Date", y = "Mean Temperature (F)") + 
  
  theme_bw() 

```


##Maximum Temperatures


```{r, label = "temps max", message = FALSE, warnings = FALSE, echo = FALSE}

weather %>% 
  
  group_by(Date) %>%
  
  
  ggplot(aes(x = Date, y = Max_Temperature_F)) + 
  
  geom_line() + 
  
  labs(x = "Date", y = "Maximum Temperature (F)") + 
  
  theme_bw() 

```


# Local Weather Events

```{r, message = FALSE, warnings = FALSE, echo = FALSE}

weather %>%
  ggplot(aes(x = as.factor(Events)))+
  geom_bar(fill = "turquoise1")+
  labs(x = "Events", y = "Number of Events") +
  theme_bw()

```

# Mean Temperature vs. Number of Trips

```{r, label = "Number of Trips", message = FALSE, warnings = FALSE, echo = FALSE}
# Make a copy of the data frame
trip_3 <- trip22

# Change column name in trip_3 to match weather dataset
trip_3$Date <- trip_3$start_date

# Left join the trip and weather dataframes by date.
trip_weather <- left_join(trip_3, weather, by = "Date")



trip_weather %>%
  group_by(Mean_Temperature_F) %>%
  summarize(N = n()) %>%
  ggplot(aes(x = round((Mean_Temperature_F/5)*5), y = N)) +
    geom_line() + 
    theme_bw() + 
    labs(x = "Temperature (Rounded to Nearest 5 degrees F)", y = "Number of Trips")
```